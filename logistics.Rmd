<center><img src="https://github.com/PsicologiaPUCP/codigos/raw/master/pics/LOGO_PUCP.png" width="500"></center>

<center> <header><h1>PSICOLOGIA: Investigación y Estadística II</h1>  </header></center>

* Profesor:  <a href="http://www.pucp.edu.pe/profesor/jose-manuel-magallanes/" target="_blank">Dr. José Manuel Magallanes, Ph.D.</a> <br>
    - Profesor del Departamento de Ciencias Sociales, Sección de Ciencia Política y Gobierno. Profesor Afiliado del Departamento de Psicología.
    - [Oficina 105](https://goo.gl/maps/xuGeG6o9di1i1y5m6) - Edificio CISEPA / ECONOMIA / CCSS
    - Telefono: (51) 1 - 6262000 anexo 4302
    - Correo Electrónico: [jmagallanes@pucp.edu.pe](mailto:jmagallanes@pucp.edu.pe)
    

____

<center> <header><h2>Regresión Logística</h2>  </header></center>
____


La data de este material está basada en el trabajo de [Cowles y Davis](https://onlinelibrary.wiley.com/doi/abs/10.1111/j.2044-8309.1987.tb00769.x). Los datos y la metadata están disponibles [aqui](http://vincentarelbundock.github.io/Rdatasets/datasets.html).

Por facilidad puedes verlos aqui en GoogleDocs:

<iframe width="800" height="600" src="https://docs.google.com/spreadsheets/d/e/2PACX-1vTnBAuw8v3PgGMivOBI9tFfGjVrZsVnteUF2y44HjZneYoajlrb9k61kWN300Q-n1q04iy8_nsB68n_/pubhtml?widget=true&amp;headers=false"></iframe>

Traigamos la data:

```{r}
link="https://docs.google.com/spreadsheets/d/e/2PACX-1vTnBAuw8v3PgGMivOBI9tFfGjVrZsVnteUF2y44HjZneYoajlrb9k61kWN300Q-n1q04iy8_nsB68n_/pub?gid=1431542138&single=true&output=csv"
vol=read.csv(link, stringsAsFactors = F)
```

Verificamos qué tipo de datos tenemos:

```{r}
str(vol)
```

Hay dos columnas que deben ser cinvertidas a categóricas:

```{r}
vol[,c(3,4)]=lapply(vol[,c(3,4)],as.factor)
```

Hay que tener en cuenta lo siguiente:

```{r}
summary(vol)
```

Las categóricas siempre se almacenan internamente como números, y éstos se asignarán por defecto en orden alfabético. De ahi que el primer nivel de cada categórica se conoce como la **categoría de referencia**.


## 1. Usando la tabla de contingencia

Queremos saber si ser mujer está relacionado con ser voluntario en estudios psicológicos. 

```{r}
ind=vol$sex # a la columna
dep=vol$volunteer # a la fila
volsexTable=table(dep,ind,dnn = c('volunteer','sex'))

### suma de columna
addmargins(volsexTable,margin = 1)
```

Saber si ser mujer está relacionado con ser voluntario implica saber dos cosas más:

* Si elijo una mujer a azar, qué probabilidad se tiene  que ésta sea voluntaria. 
* Cómo comparo el "voluntarismo" de la mujer con la del hombre.

### 1.1. Probabilidades y ODDS7

#### A. Caso de la mujer:

* La **probabilidad** que una mujer sea voluntaria, la división del ser voluntaria entre el total de mujeres:

```{r}
probMV=volsexTable[2,1]/sum(volsexTable[,1])
probMV
```

La probabilidad es un valor qu va de 0 a 1. Recuperemos la división así:

```{r}
library(MASS)
fractions(probMV)
```


* Representeos el **odds** que sea voluntaria, la división entre ser o no ser voluntaria:
```{r}
volsexTable[2,1]/volsexTable[1,1]
```

Que se origina de:

```{r}
fractions(volsexTable[2,1]/volsexTable[1,1])
```

El _odds_ suele representarse además como la razón entre dos probabilidades: la probabilidad que ocurra un evento dividido por la probabilidad que NO ocurra ese evento:

```{r}
OddsMV=probMV/(1-probMV)
OddsMV
```

#### B. Caso del hombre:

* Probabilidad que una hombre sea voluntario

```{r}
probHV=volsexTable[2,2]/sum(volsexTable[,2])
probHV
```
```{r}
fractions(probHV)
```

* El odds que hombre sea voluntario:
```{r}
OddsHV=probHV/(1-probHV)
OddsHV
```
```{r}
fractions(OddsHV)
```

#### C. Comparando Mujer y Hombre:

Para saber que diferencia produce el sexo en el voluntariado, podemos dividir los odds, lo que nos da el **odds ratio**:

```{r}
OddsMV/OddsHV
```

Con ese valor, ya sabemos que ser mujer participa más en voluntariado que los hombres. El odds ratio (OR) puede ir de 0 a infinito. Un OR de 1 implica que no hay diferencias.

```{r}
fractions(OddsMV/OddsHV)
```

Esto informa que la cantidad de mujeres que encontrarias de voluntarias ante una cantidad de hombres voluntarios.


### 1.2. Porcentajes y gráficas

Veamos la tabla de contingencia con los porcentajes por columna:

```{r}
prop.table(volsexTable,margin = 2)
```

Grafiquemoslo:

```{r}
mosaicplot( t(volsexTable),col = c("orange", "green"))
```

Esto hace intuir que la mujer se

## 2. Regresión Logística

La regresión logística modela el _logaritmo_ del odds ratio:

```{r}
vars1=vol[,c("volunteer","sex")]

rlog1=glm(volunteer~., data=vars1,family = binomial)
summary(rlog1)
```

El resultado anterior ha usado a mujer como referencia. Ahora sabes que ser hombre disminuye la probabilidad de ser voluntario. Ajustemos la referencia para ver el efecto de mujer:

```{r}
vol$sex=relevel(vol$sex,ref = "male")
vars1=vol[,c("volunteer","sex")]
rlog1=glm(volunteer~., data=vars1,family = binomial)
summary(rlog1)
```

Vemos que sexo tiene efecto, y el simbolo del coeficiente propone que el efecto es positivo. Ese valor, si le explicas exponencial, hayarás un valor conocido:

```{r}
sexF=coef(rlog1)["sexfemale"]
exp(sexF)
```

Hasta aquí pudimos haber usado aritmética con las tablas de contingencia, pero ya no son utiles si tenemos variables numéricas. La regresión logística lo hace facil:

```{r}
vars2=vol[,c("volunteer","sex","neuroticism")]
rlog2=glm(volunteer~., data=vars2,family = binomial)
summary(rlog2)
```
```{r}
vars3=vol[,c("volunteer","sex","neuroticism","extraversion")]
rlog3=glm(volunteer~., data=vars3,family = binomial)
summary(rlog3)
```

Como usamos el anova antes, podemos usar el likelihood ratio test:

```{r}
library(lmtest)
lrtest(rlog1,rlog2, rlog3)
```

Parece que el modelo 2  no es adecuado, revisemos:

```{r, results='asis'}
library(stargazer)

stargazer(rlog1,rlog2,rlog3,type = "html")
```


Confimos que el tercero es el mejor. Ahora obtengamos sus coeficientes en odds ratio:

```{r}
exp(cbind(OR = coef(rlog3), confint(rlog3)))
```






### Evaluando

```{r}
predicted <- plogis(predict(rlog3, vars3[,-1]))
```

```{r}
library(InformationValue)
confusionMatrix(vars3$volunteer, predicted)
```

```{r}
sensitivity(as.numeric(vars3$volunteer), predicted)
```
```{r}
specificity(as.numeric(vars3$volunteer), predicted)
```

```{r}
plotROC(as.numeric(vars3$volunteer), predicted)
```

No se ve tan bien.

```{r}
library(ggplot2)
ggplot(vars3, aes(x = extraversion, y = predicted))  + 
    geom_smooth(aes(colour = sex),size = 1)
```

```{r}
ggplot(vars3, aes(x = neuroticism, y = predicted))  + geom_smooth(aes(colour = sex),size = 1)
```


```{r}
ggplot(vars3, aes(x = neuroticism*extraversion, y = predicted))  + geom_smooth(aes(colour = sex),size = 1)
```

Evaluemos si los valores de neuroticism están relacionados con los de extraversion
```{r}
rlog4=glm(volunteer ~ sex + neuroticism*extraversion,
                  data=vars3, family=binomial)
summary(rlog4)
```

Pues parece que si:

```{r}
library(effects)
plot(Effect(focal.predictors = c("neuroticism","extraversion","sex"), 
            mod = rlog4),multiline=T)
```

Nos quedaremos con este modelo si es realmente mejor:
```{r}
lrtest(rlog3,rlog4)
```

Siendo que lo es, preparemos las ecuaciones:

$${log}({odds}) = {log}(\frac{{p}}{{1 – p}}) = (\beta_0 + \beta_ix_i)$$


$$Pr(VOLUNT=1|X_i) = {\frac{exp(\beta_0 + \beta_1SEX + \beta_2NEU + \beta_3EXTRAV)}{1 + exp (\beta_0 + \beta_1SEX + \beta_2NEU + \beta_3EXTRAV )}}$$


Evaluamos nuevamente:

```{r}
predicted2 <- plogis(predict(rlog4, vars3[,-1]))
```

```{r}
library(InformationValue)
confusionMatrix(vars3$volunteer, predicted2)
```

```{r}
sensitivity(as.numeric(vars3$volunteer), predicted2)
```
```{r}
specificity(as.numeric(vars3$volunteer), predicted2)
```

```{r}
plotROC(as.numeric(vars3$volunteer), predicted2)
```



Predecir probabilidad de voluntariado de una mujer con nivel de neuroticism=13 y extraversion=8: 
```{r}
ndata <- data.frame(sex=factor(c("female")), 
                      neuroticism=13, extraversion=8)
predict(object = rlog4, newdata = ndata, type = "response")
```

Predecir probabilidad de voluntariado de una mujer y hombre con los mismos niveles anteriores de neuroticism y extraversion.
```{r}
ndata <- data.frame(sex=factor(c("female","male")), 
                      neuroticism=13, extraversion=8)
predict(object = rlog4, newdata = ndata, type = "response")
```

Predecir probabilidad de voluntariado de dos mujeres,  con nivel de neuroticism de 13 y 10, y extraversion de 8 y 21, respectivamente: 
```{r}
ndata <- data.frame(sex=factor(c("female","male")), 
                      neuroticism=c(13,10), extraversion=c(8,21))
predict(object = rlog4, newdata = ndata, type = "response")
```